var Task=require("task"),Cache=require("cache"),Pathing=require("pathing"),Utilities=require("utilities"),Upgrade=function(a){this.init(a)};Upgrade.prototype=Object.create(Task.prototype);Upgrade.prototype.constructor=Upgrade;Upgrade.prototype.init=function(a){Task.call(this);this.type="upgradeController";this.room=a;this.controller=Game.rooms[a].controller;this.force=!0};
Upgrade.prototype.canAssign=function(a){if(a.spawning||!a.carry[RESOURCE_ENERGY]||"upgrader"!==a.memory.role&&_.sum(a.carry)!==a.carryCapacity&&150<=a.ticksToLive&&1E3<=this.controller.ticksToDowngrade||0===a.getActiveBodyparts(WORK))return!1;Task.prototype.assign.call(this,a);return!0};
Upgrade.prototype.run=function(a){a.say("I've;got to;celebrate;you baby;I've got;to praise;GCL like;I should!;".split(";")[Game.time%9],!0);if(this.controller&&a.carry[RESOURCE_ENERGY]&&0!==a.getActiveBodyparts(WORK)){if("upgrader"===a.memory.role){var b=Utilities.objectsClosestToObj(Cache.linksInRoom(a.room),a);0<b.length&&0<b[0].energy&&1>=a.pos.getRangeTo(b[0])&&a.withdraw(b[0],RESOURCE_ENERGY)}Pathing.moveTo(a,this.controller,Math.max(Math.min(a.pos.getRangeTo(this.controller)-1,3),1));a.transfer(this.controller,
RESOURCE_ENERGY);!Memory.signs||!Memory.signs[a.room.name]||this.controller.sign&&"roncli"===this.controller.sign.username||a.signController(this.controller,Memory.signs[a.room.name]);a.carry[RESOURCE_ENERGY]<=a.getActiveBodyparts(WORK)&&Task.prototype.complete.call(this,a)}else Task.prototype.complete.call(this,a)};Upgrade.prototype.toObj=function(a){a.memory.currentTask={type:this.type,room:this.room}};Upgrade.fromObj=function(a){return new Upgrade(a.memory.currentTask.room)};
Upgrade.getCriticalTasks=function(a){var b;if(a.controller&&a.controller.my){switch(a.controller.level){case 1:b=1E4;break;case 2:b=3500;break;case 3:b=5E3;break;case 4:b=1E4;break;case 5:b=2E4;break;case 6:b=3E4;break;case 7:b=5E4;break;case 8:b=1E5}if(a.controller.ticksToDowngrade<b)return[new Upgrade(a.name)]}return[]};Upgrade.getTasks=function(a){if(a.controller&&a.controller.my)return[new Upgrade(a.name)]};require("screeps-profiler").registerObject(Upgrade,"TaskUpgradeController");
module.exports=Upgrade;