var $jscomp={scope:{},findInternal:function(a,c,d){a instanceof String&&(a=String(a));for(var e=a.length,b=0;b<e;b++){var f=a[b];if(c.call(d,f,b,a))return{i:b,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,d,e){if(c){d=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var b=a[e];b in d||(d[b]={});d=d[b]}a=a[a.length-1];e=d[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),Market={getAllOrders:function(){if(!Market.orders||Game.cpu.bucket>=Memory.marketBucket)Market.orders=Game.market.getAllOrders(),delete Market.filteredOrders;return Market.orders},getFilteredOrders:function(){Market.filteredOrders||(Market.filteredOrders=Utilities.nest(_.filter(Market.getAllOrders(),function(a){return 0<a.amount}),[function(a){return a.type},function(a){return a.resourceType}]),_.forEach(Market.filteredOrders.sell,function(a,
c){Market.filteredOrders.sell[c].sort(function(a,c){return a.price-c.price})}),_.forEach(Market.filteredOrders.buy,function(a,c){Market.filteredOrders.buy[c].sort(function(a,c){return c.price-a.price})}));return Market.filteredOrders},deal:function(a,c,d){var e=Game.market.deal(a,c,d),b=_.find(Market.orders,function(b){return b.id===a});e===OK?b&&("sell"===b.type&&(Cache.credits-=b.amount*b.price),b.amount<=c?(Cache.log.events.push(d+" "+b.resourceType+" x"+c+" @ "+b.price+" completed, "+b.type+" sold out "+
b.id),_.remove(Market.filteredOrders[b.type][b.resourceType],function(b){return b.id===a}),_.remove(Market.orders,function(b){return b.id===a})):(b.amount-=c,Cache.log.events.push(d+" "+b.resourceType+" x"+c+" @ "+b.price+" completed, "+b.type+" "+b.amount+" remaining on "+b.id))):b&&(Cache.log.events.push(d+" failed to process order ID "+a+": "+e),_.remove(Market.filteredOrders[b.type][b.resourceType],function(b){return b.id===a}),_.remove(Market.orders,function(b){return b.id===a}));return e}};
require("screeps-profiler").registerObject(Market,"Market");module.exports=Market;