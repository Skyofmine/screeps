var Task=require("task"),Cache=require("cache"),Pathing=require("pathing"),Rally=function(a,b){this.init(a,b)};Rally.prototype=Object.create(Task.prototype);Rally.prototype.constructor=Rally;Rally.prototype.init=function(a,b){Task.call(this);this.type="rally";this.id=a;this.creep=b;this.rallyPoint=Game.getObjectById(a);this.rallyPoint||(this.rallyPoint=new RoomPosition(25,25,a),this.range=5)};Rally.prototype.canAssign=function(a){if(a.spawning)return!1;Task.prototype.assign.call(this,a);return!0};
Rally.prototype.run=function(a){var b;this.rallyPoint&&(b=a.room.name===this.rallyPoint.roomName||!(this.rallyPoint instanceof RoomPosition)||this.rallyPoint.pos&&a.room.name===this.rallyPoint.pos.roomName?this.range||0:20,a.pos.getRangeTo(this.rallyPoint)<=b?0===a.pos.x?a.move(RIGHT):49===a.pos.x?a.move(LEFT):0===a.pos.y?a.move(BOTTOM):49===a.pos.y?a.move(TOP):0<_.filter(a.pos.lookFor(LOOK_STRUCTURES),function(a){return a instanceof StructureRoad||a instanceof StructureContainer}).length&&a.move(Math.floor(8*
Math.random())):Pathing.moveTo(a,this.rallyPoint,b),a.hits<a.hitsMax&&0<a.getActiveBodyparts(HEAL)&&a.heal(a),0<a.getActiveBodyparts(RANGED_ATTACK)&&a.rangedMassAttack());Task.prototype.complete.call(this,a)};Rally.prototype.toObj=function(a){this.rallyPoint?a.memory.currentTask={type:this.type,id:this.id}:delete a.memory.currentTask};Rally.fromObj=function(a){return new Rally(a.memory.currentTask.id)};
Rally.getHarvesterTasks=function(a){return _.map(_.filter(a,function(a){return!a.spawning&&150<=a.ticksToLive}),function(a){return new Rally(a.memory.homeSource,a)})};Rally.getDefenderTask=function(a){var b=Cache.sourceKeepersInRoom(a.room).sort(function(a,b){return a.ticksToSpawn-b.ticksToSpawn})[0];return b&&a.room.name===a.memory.home?new Rally(b.id,a):new Rally(a.memory.home,a)};Rally.getClaimerTask=function(a){return new Rally(a.memory.claim,a)};
require("screeps-profiler").registerObject(Rally,"TaskRally");module.exports=Rally;