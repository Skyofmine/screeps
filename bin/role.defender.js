var Cache=require("cache"),Utilities=require("utilities"),TaskHeal=require("task.heal"),TaskRally=require("task.rally"),TaskMeleeAttack=require("task.meleeAttack"),Defender={checkSpawn:function(b){var d=b.name,c=Cache.creeps[d]&&Cache.creeps[d].defender||[],a=Game.rooms[Memory.rooms[d].roomType.supportRoom];1>_.filter(c,function(a){return a.spawning||300<=a.ticksToLive}).length&&Defender.spawn(b,a);Memory.log&&Cache.log.rooms[d].creeps.push({role:"defender",count:c.length,max:1})},spawn:function(b,
d){var c=[MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,HEAL,HEAL,HEAL,HEAL,HEAL],a=b.name,e=d.name;if(0===_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]}).length)return!1;b=_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]&&a.room.energyAvailable>=
Utilities.getBodypartCost(c)&&a.room.memory.region===d.memory.region}).sort(function(a,b){return(a.room.name===e?0:1)-(b.room.name===e?0:1)})[0];if(!b)return!1;a=b.createCreep(c,"defender-"+a+"-"+Game.time.toFixed(0).substring(4),{role:"defender",home:a,supportRoom:e});b.room.name===e&&(Cache.spawning[b.id]="number"!==typeof a);return"number"!==typeof a},assignTasks:function(b,d){b=b.name;b=_.filter(Utilities.creepsWithNoTask(Cache.creeps[b]&&Cache.creeps[b].defender||[]),function(a){return!a.spawning});
var c=[];0!==b.length&&(_.forEach(_.filter(b,function(a){return a.room.name!==a.memory.home}),function(a){TaskRally.getDefenderTask(a).canAssign(a)&&c.push(a.name)}),_.remove(b,function(a){return-1!==c.indexOf(a.name)}),c=[],0!==b.length&&(_.forEach(b,function(a){var b=TaskMeleeAttack.getDefenderTask(a);b&&b.canAssign(a)&&(a.say("Die!",!0),c.push(a.name))}),_.remove(b,function(a){return-1!==c.indexOf(a.name)}),c=[],0!==b.length&&_.forEach(_.filter(b,function(a){return a.room.name===a.memory.home}),
function(a){var b=TaskRally.getDefenderTask(a);b.range=1;b.canAssign(a)&&c.push(a.name)})))}};require("screeps-profiler").registerObject(Defender,"RoleDefender");module.exports=Defender;