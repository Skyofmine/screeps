var $jscomp={scope:{},findInternal:function(d,f,g){d instanceof String&&(d=String(d));for(var c=d.length,h=0;h<c;h++){var e=d[h];if(f.call(g,e,h,d))return{i:h,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,f,g){if(g.get||g.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[f]=g.value)};
$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(d,f,g,c){if(f){g=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var h=d[c];h in g||(g[h]={});g=g[h]}d=d[d.length-1];c=g[d];f=f(c);f!=c&&null!=f&&$jscomp.defineProperty(g,d,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,g){return $jscomp.findInternal(this,d,g).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskRally=require("task.rally"),Storer={checkSpawn:function(d){var f=Cache.containersInRoom(d),g=d.name,c=0,h=0,e,a,b,k;0!==Cache.spawnsInRoom(d).length&&0!==f.length&&d.storage&&(e=d.controller,a=Memory.army,b=Cache.creeps[g]&&Cache.creeps[g].storer||[],Memory.lengthToStorage||(Memory.lengthToStorage={}),k=Memory.lengthToStorage,_.forEach(f,function(a){var b=a.id;Memory.containerSource[b]||(Memory.containerSource[b]=Utilities.objectsClosestToObj([].concat.apply([],
[d.find(FIND_SOURCES),d.find(FIND_MINERALS)]),a)[0].id);b=Game.getObjectById(Memory.containerSource[b]);b instanceof Mineral?0<b.mineralAmount&&(h+=1):(k[a.id]||(k[a.id]=PathFinder.search(a.pos,{pos:d.storage.pos,range:1},{swampCost:1}).path.length),c+=k[a.id])}),h+=Math.ceil(2*c/(e&&6<=e.level?35:30))+(7<=e.level&&a&&0<_.filter(a,function(a){return a.region===d.memory.region}).length?1:0),_.filter(b,function(a){return a.spawning||300<=a.ticksToLive}).length<h&&Storer.spawn(d),Memory.log&&(0<b.length||
0<h)&&Cache.log.rooms[g].creeps.push({role:"storer",count:b.length,max:h}))},spawn:function(d){var f=Cache.spawnsInRoom(d),g=d.name,c,h;switch(d.controller.level){case 7:c=[MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY];break;case 8:c=[MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,
CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY];break;default:c=[MOVE,MOVE,MOVE,MOVE,MOVE,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY]}if(0===_.filter(f,function(c){return!c.spawning&&!Cache.spawning[c.id]}).length)return!1;f=_.filter(Game.spawns,function(e){return!e.spawning&&!Cache.spawning[e.id]&&e.room.energyAvailable>=Utilities.getBodypartCost(c)&&e.room.memory.region===d.memory.region}).sort(function(c,a){return(c.room.name===
g?0:1)-(a.room.name===g?0:1)})[0];if(!f)return!1;h=f.createCreep(c,"storer-"+g+"-"+Game.time.toFixed(0).substring(4),{role:"storer",home:g});Cache.spawning[f.id]="number"!==typeof h;return"number"!==typeof h},assignTasks:function(d,f){var g=d.name,c=_.filter(Utilities.creepsWithNoTask(Cache.creeps[g]&&Cache.creeps[g].storer||[]),function(a){return 0<_.sum(a.carry)||!a.spawning&&150<a.ticksToLive}),h=Cache.creeps[g]&&Cache.creeps[g].all||[],e=[];0!==c.length&&(_.forEach(f.fillEnergy.linkTasks,function(a){var b=
a.object.energyCapacity-a.object.energy-_.reduce(_.filter(h,function(k){return k.memory.currentTask&&"fillEnergy"===k.memory.currentTask.type&&k.memory.currentTask.id===a.id}),function(a,b){return a+(b.carry[RESOURCE_ENERGY]||0)},0);0<b&&(_.forEach(Utilities.objectsClosestToObj(c,a.object),function(k){if(a.canAssign(k)&&(k.say("Link"),e.push(k.name),b-=k.carry[RESOURCE_ENERGY]||0,0>=b))return!1}),_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[])}),0!==c.length&&(_.forEach(c,function(a){a.carry[RESOURCE_ENERGY]<
(8===d.controller.level?200:7===d.controller.level?100:50)||_.forEach(f.fillEnergy.extensionTasks.sort(function(b,k){return b.object.pos.getRangeTo(a)-k.object.pos.getRangeTo(a)}),function(b){if(0<b.object.energyCapacity-b.object.energy-_.reduce(_.filter(h,function(a){return a.memory.currentTask&&"fillEnergy"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(a,b){return a+(b.carry[RESOURCE_ENERGY]||0)},0)&&b.canAssign(a))return a.say("Extension"),e.push(a.name),!1})}),_.remove(c,
function(a){return-1!==e.indexOf(a.name)}),e=[],0!==c.length&&(_.forEach(f.fillEnergy.spawnTasks,function(a){var b=a.object.energyCapacity-a.object.energy-_.reduce(_.filter(h,function(b){return b.memory.currentTask&&"fillEnergy"===b.memory.currentTask.type&&b.memory.currentTask.id===a.id}),function(a,b){return a+(b.carry[RESOURCE_ENERGY]||0)},0);0<b&&(_.forEach(Utilities.objectsClosestToObj(c,a.object),function(c){if(a.canAssign(c)&&(c.say("Spawn"),e.push(c.name),b-=c.carry[RESOURCE_ENERGY]||0,0>=
b))return!1}),_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[])}),0!==c.length&&(f.fillEnergy.terminalTask&&(_.forEach(c,function(a){f.fillEnergy.terminalTask.canAssign(a)&&(a.say("Terminal"),e.push(a.name))}),_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[]),0!==c.length&&(_.forEach(f.fillEnergy.storageTasks,function(a){var b=a.object.storeCapacity-_.sum(a.object.store)-_.reduce(_.filter(a.object.room.find(FIND_MY_CREEPS),function(b){return b.memory.currentTask&&["fillEnergy",
"fillMinerals"].indexOf(b.memory.currentTask.type)&&b.memory.currentTask.id===a.id}),function(a,b){return a+_.sum(b.carry)},0);0<b&&(_.forEach(Utilities.objectsClosestToObj(c,a.object),function(c){if((!d.terminal||!c.memory.lastCollectEnergyWasStorage)&&a.canAssign(c)&&(c.say("Storage"),e.push(c.name),b-=_.sum(c.carry),0>=b))return!1}),_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[])}),0!==c.length&&(_.forEach(f.fillMinerals.storageTasks,function(a){_.forEach(c,function(b){a.canAssign(b)&&
(b.say("Storage"),e.push(b.name))});_.remove(c,function(a){return-1!==e.indexOf(a.name)});e=[]}),0!==c.length&&(_.forEach(f.fillMinerals.terminalTasks,function(a){_.forEach(c,function(b){a.canAssign(b)&&(b.say("Terminal"),e.push(b.name))});_.remove(c,function(a){return-1!==e.indexOf(a.name)});e=[]}),0!==c.length&&(_.forEach([].concat.apply([],[f.collectEnergy.storerTasks,f.collectMinerals.storerTasks]).sort(function(a,b){return(b.object.energy||_.sum(b.object.store)||0)-(a.object.energy||_.sum(a.object.store)||
0)}),function(a){if(a.object.energy||_.sum(a.object.store)){var b=(a.object.energy||_.sum(a.object.store)||0)-_.reduce(_.filter(a.object.room.find(FIND_MY_CREEPS),function(b){return b.memory.currentTask&&b.memory.currentTask.type===a.type&&b.memory.currentTask.id===a.id}),function(a,b){return a+(b.carryCapacity-_.sum(b.carry))},0);500<=b&&(_.forEach(c,function(c){c.memory.lastCollectEnergyWasStorage=!1;if(a.canAssign(c)&&(c.say("Collecting"),e.push(c.name),b-=c.carryCapacity-_.sum(c.carry),500>b))return!1}),
_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[])}}),0!==c.length&&(f.collectEnergy.terminalTask&&(_.forEach(c,function(a){f.collectEnergy.terminalTask.canAssign(a)&&(a.say("Collecting"),e.push(a.name),a.memory.lastCollectEnergyWasStorage=!1)}),_.remove(c,function(a){return-1!==e.indexOf(a.name)}),e=[]),0!==c.length&&(_.forEach(f.collectEnergy.tasks,function(a){_.forEach(c,function(b){a.canAssign(b)&&(b.say("Collecting"),e.push(b.name),a.object instanceof StructureStorage&&(b.memory.lastCollectEnergyWasStorage=
!0))});_.remove(c,function(a){return-1!==e.indexOf(a.name)});e=[]}),0!==c.length&&_.forEach(c,function(a){var b=new TaskRally(a.room.terminal?a.room.terminal.id:a.room.name);b.range=0;b.canAssign(a)})))))))))))}};require("screeps-profiler").registerObject(Storer,"RoleStorer");module.exports=Storer;