var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var g=a[e];if(b.call(c,g,e,a))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskMine=require("task.mine"),TaskRally=require("task.rally"),Miner={checkSpawn:function(a){var b=a.name,c=Game.rooms[Memory.rooms[b].roomType.supportRoom],d=c.name,e=Cache.creeps[b]&&Cache.creeps[b].remoteMiner||[],g=Cache.containersInRoom(a),f=0;0===Cache.spawnsInRoom(c).length||a.unobservable||0===g.length||(Memory.lengthToContainer||(Memory.lengthToContainer={}),_.forEach(g,function(b){var h=b.id;Memory.lengthToContainer[h]||(Memory.lengthToContainer[h]=
{});Memory.lengthToContainer[h][d]||(Memory.lengthToContainer[h][d]=PathFinder.search(b.pos,{pos:Cache.spawnsInRoom(c)[0].pos,range:1},{swampCost:1,maxOps:1E5}).path.length);Memory.containerSource[h]||(Memory.containerSource[h]=Utilities.objectsClosestToObj([].concat.apply([],[a.find(FIND_SOURCES),a.find(FIND_MINERALS)]),b)[0].id);b=Game.getObjectById(Memory.containerSource[h]);b instanceof Mineral&&0===b.mineralAmount||(f+=1,0===_.filter(e,function(a){return(a.spawning||a.ticksToLive>=150+3*Memory.lengthToContainer[h][d])&&
a.memory.container===h}).length&&Miner.spawn(a,c,h))}),Memory.log&&(0<e.length||0<f)&&Cache.log.rooms[b].creeps.push({role:"remoteMiner",count:e.length,max:f}))},spawn:function(a,b,c){var d=a.memory&&a.memory.roomType&&"source"===a.memory.roomType.type||/^[EW][1-9][0-9]*5[NS][1-9][0-9]*5$/.test(a.name)?[MOVE,MOVE,MOVE,MOVE,WORK,WORK,WORK,WORK,WORK,WORK,WORK]:[MOVE,MOVE,MOVE,WORK,WORK,WORK,WORK,WORK],e=a.name,g=b.name,f,k;if(0===_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]}).length)return!1;
if(Utilities.objectsClosestToObj([].concat.apply([],[a.find(FIND_SOURCES),a.find(FIND_MINERALS)]),Game.getObjectById(c))[0]instanceof Mineral){d=[];f=Math.min(b.energyCapacityAvailable,4500);a=Math.floor(f/450);f%=450;for(k=0;k<a;k++)d.push(MOVE);50<=f&&d.push(MOVE);for(k=0;k<a;k++)d.push(WORK),d.push(WORK),d.push(WORK),d.push(WORK);150<=f&&d.push(WORK);250<=f&&d.push(WORK);350<=f&&d.push(WORK)}a=_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]&&a.room.energyAvailable>=Utilities.getBodypartCost(d)&&
a.room.memory.region===b.memory.region}).sort(function(a,b){return(a.room.name===g?0:1)-(b.room.name===g?0:1)})[0];if(!a)return!1;c=a.createCreep(d,"remoteMiner-"+e+"-"+Game.time.toFixed(0).substring(4),{role:"remoteMiner",home:e,supportRoom:g,container:c});a.room.name===g&&(Cache.spawning[a.id]="number"!==typeof c);return"number"!==typeof c},assignTasks:function(a,b){b=a.name;b=Utilities.creepsWithNoTask(Cache.creeps[b]&&Cache.creeps[b].remoteMiner||[]);var c=[];0!==b.length&&(a.unobservable||_.forEach(b,
function(a){(new TaskMine).canAssign(a)&&(a.say("Mining"),c.push(a.name))}),_.remove(b,function(a){return-1!==c.indexOf(a.name)}),c=[],0!==b.length&&_.forEach(b,function(a){(new TaskRally(a.memory.home)).canAssign(a)}))}};require("screeps-profiler").registerObject(Miner,"RoleRemoteMiner");module.exports=Miner;