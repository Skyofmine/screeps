var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,b={next:function(){if(c<a.length){var g=c++;return{value:d(g,a[g]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,d,c,b){if(d){c=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var g=a[b];g in c||(c[g]={});c=c[g]}a=a[a.length-1];b=c[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
$jscomp.checkStringArgs=function(a,d,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(d instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var d=b.length,e=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var f=0;f<e&&c<d;)if(b[c++]!=a[f++])return!1;return f>=e}},"es6-impl","es3");var Task=require("task"),Cache=require("cache"),Pathing=require("pathing"),Utilities=require("utilities"),CollectMinerals=function(a,d,c){this.init(a,d,c)};CollectMinerals.prototype=Object.create(Task.prototype);
CollectMinerals.prototype.constructor=CollectMinerals;CollectMinerals.prototype.init=function(a,d,c){Task.call(this);this.type="collectMinerals";this.id=a;this.resource=d;this.amount=c;this.object=Game.getObjectById(a)};
CollectMinerals.prototype.canAssign=function(a){var d=this.object;if(0>this.amount||a.spawning||150>a.ticksToLive||_.sum(a.carry)===a.carryCapacity||0<a.carry[RESOURCE_ENERGY]||this.resource&&this.amount&&(d.structureType===STRUCTURE_LAB&&d.mineralType!==this.resource&&d.mineralAmount<this.amount||d.structureType!==STRUCTURE_LAB&&(d.store[this.resource]||0)<this.amount))return!1;Task.prototype.assign.call(this,a);return!0};
CollectMinerals.prototype.run=function(a){var d=this.object,c=this.resource,b=a.carry,g=a.carryCapacity,e=this.amount,f;if(0>e||150>a.ticksToLive||!d)Task.prototype.complete.call(this,a);else if(f=d.store,_.sum(a.carry)===a.carryCapacity)Task.prototype.complete.call(this,a);else{if(d.structureType===STRUCTURE_LAB){if(null===d.mineralType){Task.prototype.complete.call(this,a);return}c=[d.mineralType]}else c=c?[c]:_.filter(_.keys(f),function(a){return a!==RESOURCE_ENERGY&&0<f[a]});0===c.length?Task.prototype.complete.call(this,
a):(Pathing.moveTo(a,d,1),e?a.withdraw(d,c[0],Math.min(e,g-_.sum(b)))===OK&&Task.prototype.complete.call(this,a):a.withdraw(d,c[0])===OK&&Task.prototype.complete.call(this,a))}};CollectMinerals.prototype.toObj=function(a){this.object?a.memory.currentTask={type:this.type,id:this.id,resource:this.resource,amount:this.amount}:delete a.memory.currentTask};CollectMinerals.fromObj=function(a){return new CollectMinerals(a.memory.currentTask.id,a.memory.currentTask.resource,a.memory.currentTask.amount)};
CollectMinerals.getStorerTasks=function(a){return _.map(_.filter(Cache.containersInRoom(a),function(a){return 0<_.filter(_.keys(a.store),function(d){return d!==RESOURCE_ENERGY&&500<=a.store[d]}).length}).sort(function(a,c){return _.sum(c.store)-_.sum(a.store)}),function(a){return new CollectMinerals(a.id)})};
CollectMinerals.getCleanupTasks=function(a){return _.map(_.filter(a,function(a){return(a.store||a.structureType===STRUCTURE_LAB)&&(0<_.sum(a.store)&&a.store[RESOURCE_ENERGY]<_.sum(a.store)||0<a.mineralAmount)}).sort(function(a,c){return(a.structureType===STRUCTURE_LAB?a.mineralAmount:_.sum(a.store)-a.store[RESOURCE_ENERGY])-(c.structureType===STRUCTURE_LAB?c.mineralAmount:_.sum(c.store)-c.store[RESOURCE_ENERGY])}),function(a){return new CollectMinerals(a.id)})};
CollectMinerals.getLabTasks=function(a){var d=a.memory,c=d.labsInUse,b=d.labQueue,d=a.storage,g=Cache.labsInRoom(a),e=[],f,h;b&&(f=b.status,h=b.sourceLabs);c&&(_.forEach(c,function(a){Game.creeps[a.creepToBoost]||e.push(new CollectMinerals(a.id))}),_.forEach(e,function(a){_.remove(c,function(b){return b.id===a.id})}));d&&b&&"clearing"===f&&_.forEach(_.filter(g,function(a){return-1===_.map(c,function(a){return a.id}).indexOf(a.id)&&0<a.mineralAmount}),function(a){e.push(new CollectMinerals(a.id))});
d&&c&&_.forEach(_.filter(c,function(a){return(!a.status||"emptying"===a.status)&&Game.getObjectById(a.id).mineralType&&Game.getObjectById(a.id).mineralType!==a.resource}),function(a){e.push(new CollectMinerals(a.id))});d&&b&&"creating"===f&&!Utilities.roomLabsArePaused(a)&&(0===Game.getObjectById(h[0]).mineralAmount&&0!==Game.getObjectById(h[1]).mineralAmount&&e.push(new CollectMinerals(h[1])),0!==Game.getObjectById(h[0]).mineralAmount&&0===Game.getObjectById(h[1]).mineralAmount&&e.push(new CollectMinerals(h[0])));
d&&b&&"returning"===f&&_.forEach(_.filter(g,function(a){return a.mineralType===b.resource}),function(a){e.push(new CollectMinerals(a.id))});return e};
CollectMinerals.getStorageTasks=function(a){var d=[],c;a.controller&&6<=a.controller.level&&(a.storage&&a.memory.labsInUse&&_.forEach(_.filter(a.memory.labsInUse,function(a){return(!a.status||-1!==["filling","refilling"].indexOf(a.status))&&(!Game.getObjectById(a.id).mineralType||Game.getObjectById(a.id).mineralType===("refilling"===a.status?a.oldResource:a.resource))}),function(b){0<("refilling"===b.status?b.oldAmount-Game.getObjectById(b.id).mineralAmount:b.amount-Game.getObjectById(b.id).mineralAmount)&&
d.push(new CollectMinerals(a.storage.id,"refilling"===b.status?b.oldResource:b.resource,"refilling"===b.status?b.oldAmount-Game.getObjectById(b.id).mineralAmount:b.amount-Game.getObjectById(b.id).mineralAmount))}),a.storage&&a.memory.labQueue&&"moving"===a.memory.labQueue.status&&3<=Cache.labsInRoom(a).length&&!Utilities.roomLabsArePaused(a)&&_.forEach(a.memory.labQueue.children,function(b){(c=_.sum(_.filter(Cache.labsInRoom(a),function(a){return a.mineralType===b}),function(a){return a.mineralAmount}))<
a.memory.labQueue.amount&&d.push(new CollectMinerals(a.storage.id,b,a.memory.labQueue.amount-c))}),a.storage&&a.terminal&&Memory.reserveMinerals&&_.forEach(a.storage.store,function(b,c){c!==RESOURCE_ENERGY&&(Memory.reserveMinerals[c]?(c.startsWith("X")&&5===c.length?Memory.reserveMinerals[c]-5E3:Memory.reserveMinerals[c])<b&&d.push(new CollectMinerals(a.storage.id,c,b-(c.startsWith("X")&&5===c.length?Memory.reserveMinerals[c]-5E3:Memory.reserveMinerals[c]))):d.push(new CollectMinerals(a.storage.id,
c,b)))}),8<=a.controller.level&&(_.forEach(Cache.nukersInRoom(a),function(b){b.ghodium<b.ghodiumCapacity&&d.push(new CollectMinerals(a.storage.id,RESOURCE_GHODIUM,b.ghodiumCapacity-b.ghodium))}),_.forEach(Cache.powerSpawnsInRoom(a),function(b){b.power<b.powerCapacity&&d.push(new CollectMinerals(a.storage.id,RESOURCE_POWER,b.powerCapacity-b.power))})));return d};
CollectMinerals.getTerminalTasks=function(a){var d=[];a.storage&&a.terminal&&Memory.reserveMinerals&&_.forEach(a.terminal.store,function(c,b){b!==RESOURCE_ENERGY&&Memory.reserveMinerals[b]&&(a.storage.store[b]?a.storage.store[b]<(b.startsWith("X")&&5===b.length?Memory.reserveMinerals[b]-5E3:Memory.reserveMinerals[b])&&d.push(new CollectMinerals(a.terminal.id,b,Math.min(c,(b.startsWith("X")&&5===b.length?Memory.reserveMinerals[b]-5E3:Memory.reserveMinerals[b])-a.storage.store[b]))):d.push(new CollectMinerals(a.terminal.id,
b,Math.min(c,b.startsWith("X")&&5===b.length?Memory.reserveMinerals[b]-5E3:Memory.reserveMinerals[b]))))});return d};require("screeps-profiler").registerObject(CollectMinerals,"TaskCollectMinerals");module.exports=CollectMinerals;