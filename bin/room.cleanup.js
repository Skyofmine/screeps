var $jscomp={scope:{},findInternal:function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var h=a[e];if(c.call(b,h,e,a))return{i:e,v:h}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
var RoomObj=require("roomObj"),Cache=require("cache"),Commands=require("commands"),Utilities=require("utilities"),RoleDismantler=require("role.dismantler"),RoleRemoteDismantler=require("role.remoteDismantler"),RoleRemoteCollector=require("role.remoteCollector"),TaskCollectEnergy=require("task.collectEnergy"),TaskCollectMinerals=require("task.collectMinerals"),TaskDismantle=require("task.dismantle"),TaskFillEnergy=require("task.fillEnergy"),TaskFillMinerals=require("task.fillMinerals"),Cleanup=function(a){this.init(a)};
Cleanup.prototype=Object.create(RoomObj.prototype);Cleanup.prototype.constructor=Cleanup;Cleanup.prototype.init=function(a){RoomObj.call(this);this.type="cleanup";this.supportRoom=a};
Cleanup.prototype.run=function(a){var c=a.name,b=[],d=[],e=[],h=[],l=[],f,g;if(f=Game.rooms[Memory.rooms[a.name].roomType.supportRoom])g={collectEnergy:{cleanupTasks:[]},collectMinerals:{cleanupTasks:[]},fillEnergy:{storageTasks:TaskFillEnergy.getStorageTasks(f),containerTasks:TaskFillEnergy.getContainerTasks(f)},fillMinerals:{labTasks:TaskFillMinerals.getLabTasks(f),storageTasks:TaskFillMinerals.getStorageTasks(f),terminalTasks:TaskFillMinerals.getTerminalTasks(f)},remoteDismantle:{cleanupTasks:[]},
dismantle:{tasks:[]}},a.unobservable||(Memory.dismantle&&Memory.dismantle[a.name]&&0<Memory.dismantle[a.name].length?(_.forEach(Memory.dismantle[a.name],function(k){var b=a.lookForAt(LOOK_STRUCTURES,k.x,k.y);0===b.length?l.push(k):g.dismantle.tasks=g.dismantle.tasks.concat(_.map(b,function(a){return new TaskDismantle(a.id)}))}),_.forEach(l,function(a){_.remove(Memory.dismantle[c],function(k){return k.x===a.x&&k.y===a.y})})):_.forEach(Cache.creeps[c]&&Cache.creeps[c].dismantler||[],function(a){a.memory.role=
"worker";a.memory.home=f.name}),b=_.filter(a.find(FIND_STRUCTURES),function(a){return a.structureType===STRUCTURE_RAMPART}),d=_.filter(a.find(FIND_STRUCTURES),function(a){return a.structureType!==STRUCTURE_RAMPART&&a.structureType!==STRUCTURE_CONTROLLER&&a.structureType!==STRUCTURE_ROAD&&a.structureType!==STRUCTURE_WALL&&(0===b.length||0<a.pos.getRangeTo(Utilities.objectsClosestToObj(b,a)[0]))}),e=_.filter(d,function(a){return(!a.energy||0===a.energy)&&(!a.store||0===_.sum(a.store))&&(!a.mineralAmount||
0===a.mineralAmount)}),h=_.filter(d,function(a){return a.energy&&0<a.energy||a.store&&0<_.sum(a.store)||a.mineralAmount&&0<a.mineralAmount}),g.collectEnergy.cleanupTasks=TaskCollectEnergy.getCleanupTasks(h),g.collectMinerals.cleanupTasks=TaskCollectMinerals.getCleanupTasks(h),g.remoteDismantle.cleanupTasks=0<e.length?TaskDismantle.getCleanupTasks(e):TaskDismantle.getCleanupTasks(b),0===h.length&&0===g.remoteDismantle.cleanupTasks.length&&(Game.notify("Cleanup Room "+a.name+" is squeaky clean!"),_.forEach(Cache.creeps[c]&&
Cache.creeps[c].remoteCollector||[],function(a){a.memory.role="storer";a.memory.home=f.name}),_.forEach(Cache.creeps[c]&&Cache.creeps[c].remoteDismantler||[],function(a){a.memory.role="upgrader";a.memory.home=f.name}),Commands.setRoomType(a.name))),(a.unobservable||0<d.length||0<b.length)&&RoleRemoteDismantler.checkSpawn(a,f),Memory.dismantle&&Memory.dismantle[a.name]&&0<Memory.dismantle[a.name].length&&RoleDismantler.checkSpawn(a,f),0<h.length&&RoleRemoteCollector.checkSpawn(a,f),RoleRemoteDismantler.assignTasks(a,
g),RoleDismantler.assignTasks(a,g),RoleRemoteCollector.assignTasks(a,g)};Cleanup.prototype.toObj=function(a){Memory.rooms[a.name].roomType={type:this.type,supportRoom:this.supportRoom}};Cleanup.fromObj=function(a){return new Cleanup(a.roomType.supportRoom)};require("screeps-profiler").registerObject(Cleanup,"RoomCleanup");module.exports=Cleanup;