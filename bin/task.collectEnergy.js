var Task=require("task"),Cache=require("cache"),Pathing=require("pathing"),CollectEnergy=function(a){this.init(a)};CollectEnergy.prototype=Object.create(Task.prototype);CollectEnergy.prototype.constructor=CollectEnergy;CollectEnergy.prototype.init=function(a){Task.call(this);this.type="collectEnergy";this.id=a;this.object=Game.getObjectById(a)};
CollectEnergy.prototype.canAssign=function(a){var b;if(a.spawning||150>a.ticksToLive||_.sum(a.carry)===a.carryCapacity||!this.object)return!1;b=this.object.energy;void 0===b&&(b=this.object.store[RESOURCE_ENERGY]||0);if(0===b)return!1;Task.prototype.assign.call(this,a);return!0};
CollectEnergy.prototype.run=function(a){var b=this.object,c,d;150>a.ticksToLive||!b?Task.prototype.complete.call(this,a):(c=b.energy||b.store[RESOURCE_ENERGY]||0,_.sum(a.carry)===a.carryCapacity||0===c?Task.prototype.complete.call(this,a):(Pathing.moveTo(a,b,1),1===a.pos.getRangeTo(b)&&0<(d=_.filter(b.pos.lookFor(LOOK_RESOURCES),function(b){return 50<b.amount})).length?a.pickup(d[0]):a.withdraw(b,RESOURCE_ENERGY)===OK&&Task.prototype.complete.call(this,a)))};
CollectEnergy.prototype.toObj=function(a){this.object?a.memory.currentTask={type:this.type,id:this.id}:delete a.memory.currentTask};CollectEnergy.fromObj=function(a){return new CollectEnergy(a.memory.currentTask.id)};
CollectEnergy.getTasks=function(a){return _.map(_.filter([].concat.apply([],[_.filter(Cache.containersInRoom(a),function(b){return 500<=b.store[RESOURCE_ENERGY]}),a.storage?[a.storage]:[]]),function(b){return b.store[RESOURCE_ENERGY]&&0<b.store[RESOURCE_ENERGY]}).sort(function(b,a){return(a.structureType===STRUCTURE_STORAGE?2E3:0+a.store[RESOURCE_ENERGY])-(b.structureType===STRUCTURE_STORAGE?2E3:0+b.store[RESOURCE_ENERGY])}),function(b){return new CollectEnergy(b.id)})};
CollectEnergy.getStorerTasks=function(a){return _.map(_.filter(Cache.containersInRoom(a),function(b){return b.store[RESOURCE_ENERGY]&&500<=b.store[RESOURCE_ENERGY]}),function(b){return new CollectEnergy(b.id)})};CollectEnergy.getCleanupTasks=function(a){return _.map(_.filter(a,function(b){return b.energy||b.store&&b.store[RESOURCE_ENERGY]}).sort(function(b,a){return(b.energy||b.store[RESOURCE_ENERGY])-(a.energy||a.store[RESOURCE_ENERGY])}),function(a){return new CollectEnergy(a.id)})};
require("screeps-profiler").registerObject(CollectEnergy,"TaskCollectEnergy");module.exports=CollectEnergy;