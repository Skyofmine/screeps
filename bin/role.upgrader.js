var $jscomp={scope:{},findInternal:function(b,e,c){b instanceof String&&(b=String(b));for(var a=b.length,d=0;d<a;d++){var g=b[d];if(e.call(c,g,d,b))return{i:d,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[e]=c.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,e,c,a){if(e){c=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var d=b[a];d in c||(c[d]={});c=c[d]}b=b[b.length-1];a=c[b];e=e(a);e!=a&&null!=e&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskCollectEnergy=require("task.collectEnergy"),TaskHarvest=require("task.harvest"),TaskRally=require("task.rally"),Upgrader={checkSpawn:function(b){var e=b.name,c=Cache.creeps[e]&&Cache.creeps[e].upgrader||[],a=b.storage,d=b.controller,g,p,h;0!==Cache.spawnsInRoom(b).length&&(a&&(g=a.store[RESOURCE_ENERGY]),p=_.filter(c,function(b){return b.spawning||150<=b.ticksToLive}).length,h=e===Memory.rushRoom?1:!a||g<Memory.upgradeEnergy?0:1,(p<h||
d&&8>d.level&&a&&9E5<g)&&Upgrader.spawn(b),Memory.log&&(0<c.length||0<h)&&Cache.log.rooms[e].creeps.push({role:"upgrader",count:c.length,max:h}),_.forEach(_.filter(Game.rooms,function(a){return a.memory&&a.memory.roomType&&"base"===a.memory.roomType.type&&a.memory.region===b.memory.region&&a.name!==b.name&&a.controller&&a.controller.my&&7>a.controller.level}),function(a){0===_.filter(Cache.creeps[a.name]&&Cache.creeps[a.name].upgrader||[],function(a){return a.memory.supportRoom!==a.memory.home}).length&&
Upgrader.spawn(a,b)}))},spawn:function(b,e){var c=[],a=b.controller,d=0,g=!1,p=b.name,h,q,k,n,l,f,m;e||(e=b);h=e.name;q=Cache.spawnsInRoom(e);k=e.storage;if(0===_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]}).length)return!1;if(2<=Cache.linksInRoom(b).length&&2>=Utilities.objectsClosestToObj(Cache.linksInRoom(b),a)[0].pos.getRangeTo(a)){a=Math.min(e.energyCapacityAvailable,8===a.level?1950:4100);n=Math.floor((a-50*Math.ceil(a/3200))/250);l=(a-50*Math.ceil(a/3200))%250;
for(f=0;f<n;f++)c.push(WORK),c.push(WORK),d+=2;150<=l&&(c.push(WORK),d++);for(f=0;f<Math.ceil(a/3200);f++)c.push(CARRY)}else{a=Math.min(e.energyCapacityAvailable,8===a.level?3E3:3300);n=Math.floor(a/200);l=a%200;for(f=0;f<n;f++)c.push(WORK),d++;150<=l&&(c.push(WORK),d++);for(f=0;f<n;f++)c.push(CARRY);100<=l&&150>l&&c.push(CARRY)}for(f=0;f<n;f++)c.push(MOVE);50<=l&&c.push(MOVE);0<d&&k&&0<Cache.labsInRoom(e).length&&Math.max(k.store[RESOURCE_GHODIUM_HYDRIDE]||0,k.store[RESOURCE_GHODIUM_ACID]||0,k.store[RESOURCE_CATALYZED_GHODIUM_ACID]||
0)>=30*d&&(g=!!(m=Utilities.getLabToBoostWith(e)[0]));a=3>Cache.labsInRoom(e).length?_.filter(Game.spawns,function(a){return!a.spawning&&!Cache.spawning[a.id]&&a.room.energyAvailable>=Utilities.getBodypartCost(c)&&a.room.memory.region===e.memory.region}).sort(function(a,b){return(a.room.name===h?0:1)-(b.room.name===h?0:1)})[0]:_.filter(q,function(a){return!a.spawning&&!Cache.spawning[a.id]&&a.room.energyAvailable>=Utilities.getBodypartCost(c)})[0];if(!a)return!1;b=a.createCreep(c,"upgrader-"+p+"-"+
Game.time.toFixed(0).substring(4),{role:"upgrader",home:p,supportRoom:h,homeSource:Utilities.objectsClosestToObj(b.find(FIND_SOURCES),q[0])[0].id,labs:g?[m.id]:[]});Cache.spawning[a.id]="number"!==typeof b;"number"!==typeof b&&g&&(m.creepToBoost=b,m.resource=k.store[RESOURCE_CATALYZED_GHODIUM_ACID]>=30*d?RESOURCE_CATALYZED_GHODIUM_ACID:k.store[RESOURCE_GHODIUM_ACID]>=30*d?RESOURCE_GHODIUM_ACID:RESOURCE_GHODIUM_HYDRIDE,m.amount=30*d,e.memory.labsInUse.push(m),_.forEach(_.filter(Cache.creeps[h]&&Cache.creeps[h].all||
[],function(a){return a.memory.currentTask&&"fillMinerals"===a.memory.currentTask.type&&a.memory.currentTask.id===m.id}),function(a){delete a.memory.currentTask}));return"number"!==typeof b},assignTasks:function(b,e){var c=b.name,a=_.filter(Utilities.creepsWithNoTask(Cache.creeps[c]&&Cache.creeps[c].upgrader||[]),function(a){return 0<_.sum(a.carry)||!a.spawning&&150<a.ticksToLive}),d=[],g=b.controller;if(0!==a.length&&(_.forEach(_.filter(a,function(a){return a.memory.labs&&0<a.memory.labs.length}),
function(a){(new TaskRally(a.memory.labs[0])).canAssign(a);d.push(a.name)}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[],0!==a.length&&(_.forEach(e.upgradeController.tasks,function(b){_.forEach(Utilities.objectsClosestToObj(a,g),function(a){b.canAssign(a)&&(a.say("Controller"),d.push(a.name))});_.remove(a,function(a){return-1!==d.indexOf(a.name)});d=[]}),0!==a.length&&(_.forEach(a,function(a){var c=Utilities.objectsClosestToObj(Cache.linksInRoom(b),g);0<c.length&&0<c[0].energy&&(c=new TaskCollectEnergy(c[0].id),
c.canAssign(a)&&(a.say("Collecting"),d.push(a.name)))}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[],0!==a.length&&(_.forEach(e.collectEnergy.tasks,function(b){_.forEach(a,function(a){b.canAssign(a)&&(a.say("Collecting"),d.push(a.name))});_.remove(a,function(a){return-1!==d.indexOf(a.name)});d=[]}),0!==a.length))))){if(0===_.filter(Cache.containersInRoom(b),function(a){return 0<a.energy}).length&&!b.storage&&(_.forEach(a,function(a){(new TaskHarvest).canAssign(a)&&(a.say("Harvesting"),
d.push(a.name))}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[],0===a.length))return;_.forEach(TaskRally.getHarvesterTasks(a),function(a){a.canAssign(a.creep)})}}};require("screeps-profiler").registerObject(Upgrader,"RoleUpgrader");module.exports=Upgrader;