var $jscomp={scope:{},findInternal:function(b,k,e){b instanceof String&&(b=String(b));for(var c=b.length,d=0;d<c;d++){var h=b[d];if(k.call(e,h,d,b))return{i:d,v:h}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,k,e){if(e.get||e.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[k]=e.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,k,e,c){if(k){e=$jscomp.global;b=b.split(".");for(c=0;c<b.length-1;c++){var d=b[c];d in e||(e[d]={});e=e[d]}b=b[b.length-1];c=e[b];k=k(c);k!=c&&null!=k&&$jscomp.defineProperty(e,b,{configurable:!0,writable:!0,value:k})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,e){return $jscomp.findInternal(this,b,e).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskDismantle=require("task.dismantle"),TaskRally=require("task.rally"),Dismantler={checkSpawn:function(b,k){var e=_.filter(Cache.creepsInArmy("armyDismantler",b),function(b){return b.spawning||300<b.ticksToLive}).length,c=Memory.army[b].dismantler.maxCreeps;e<c&&Dismantler.spawn(b,k);Memory.log&&0<c&&Cache.log.army[b].creeps.push({role:"armyDismantler",count:e,max:c})},spawn:function(b,k){var e=Memory.army[b],c=e.dismantler.units,d=[],h,m,
f,l;e.boostRoom&&(h=Game.rooms[e.boostRoom],m=h.memory.labsInUse);if(0===_.filter(Game.spawns,function(b){return!b.spawning&&!Cache.spawning[b.id]}).length)return!1;for(f=0;5>f;f++)d.push(TOUGH);for(f=0;f<c;f++)d.push(WORK);for(f=0;f<c+5;f++)d.push(MOVE);if(h&&!(l=Utilities.getLabToBoostWith(h,2)))return!1;f=_.filter(Game.spawns,function(b){return!b.spawning&&!Cache.spawning[b.id]&&b.room.energyAvailable>=Utilities.getBodypartCost(d)&&b.room.memory.region===e.region})[0];if(!f)return!1;b=f.createCreep(d,
"armyDismantler-"+b+"-"+Game.time.toFixed(0).substring(4),{role:"armyDismantler",army:b,labs:h?_.map(l,function(b){return b.id}):[],portals:k});Cache.spawning[f.id]="number"!==typeof b;"number"!==typeof b&&h&&(l[0].creepToBoost=b,l[0].resource=RESOURCE_CATALYZED_GHODIUM_ALKALIDE,l[0].amount=150,m.push(l[0]),l[1].creepToBoost=b,l[1].resource=RESOURCE_CATALYZED_ZYNTHIUM_ACID,l[1].amount=30*c,m.push(l[1]),Cache.creeps[h.name]&&_.forEach(_.filter(Cache.creeps[h.name].all,function(b){return b.memory.currentTask&&
"fillMinerals"===b.memory.currentTask.type&&-1!==_.map(l,function(b){return b.id}).indexOf(b.memory.currentTask.id)}),function(b){delete b.memory.currentTask}));return"number"!==typeof b},assignTasks:function(b,k,e){var c=_.filter(Utilities.creepsWithNoTask(Cache.creepsInArmy("armyDismantler",b)),function(a){return!a.spawning}),d=[],h=Memory.army[b],m=h.stageRoom,f=h.attackRoom,l=Game.rooms[f],p=h.dismantle,g,n;if(0!==c.length)switch(k){case "building":_.forEach(_.filter(c,function(a){return a.memory.labs&&
0<a.memory.labs.length}),function(a){(new TaskRally(a.memory.labs[0])).canAssign(a);d.push(a.name)});_.remove(c,function(a){return-1!==d.indexOf(a.name)});d=[];if(0===c.length)break;g=new TaskRally(h.buildRoom);_.forEach(c,function(a){a.say("Building");a.memory.portaling&&a.memory.portals[0]!==a.room.name&&a.memory.portals.shift();a.memory.portals&&0<a.memory.portals.length?a.memory.portals[0]===a.room.name?(a.memory.portaling=!0,g=new TaskRally(Cache.portalsInRoom(a.room)[0].id)):g=new TaskRally(a.memory.portals[0]):
g=new TaskRally(h.buildRoom);g.canAssign(a)});break;case "staging":g=new TaskRally(m);_.forEach(c,function(a){a.say("Staging");g.canAssign(a)});break;case "dismantle":n=Cache.creepsInArmy("armyHealer",b);if(0<n.length&&m!==f&&(g=new TaskRally(m),_.forEach(_.filter(c,function(a){return(a.room.name===f||1>=a.pos.x||48<=a.pos.x||1>=a.pos.y||48<=a.pos.y)&&1E3<=a.hitsMax-a.hits}),function(a){a.say("Ouch!");g.canAssign(a);d.push(a.name)}),_.remove(c,function(a){return-1!==d.indexOf(a.name)}),d=[],0===c.length))break;
if(0<n.length&&(_.forEach(c,function(a){var b=Utilities.objectsClosestToObj(n,a);2<b[0].pos.getRangeTo(a)&&(b=new TaskRally(b[0].id),b.canAssign(a),d.push(a.name))}),_.remove(c,function(a){return-1!==d.indexOf(a.name)}),d=[],0===c.length))break;0<n.length&&_.remove(c,function(a){return 1E3<=a.hitsMax-a.hits});if(l&&0<p.length&&(g=new TaskDismantle(p[0]),_.forEach(c,function(a){g.canAssign(a)&&(a.say("Dismantle"),d.push(a.name))}),_.remove(c,function(a){return-1!==d.indexOf(a.name)}),d=[],0===c.length))break;
g=new TaskRally(f);_.forEach(c,function(a){g.canAssign(a)});break;case "attack":n=Cache.creepsInArmy("armyHealer",b);if(0<n.length&&m!==f&&(g=new TaskRally(m),_.forEach(_.filter(c,function(a){return(a.room.name===f||1>=a.pos.x||48<=a.pos.x||1>=a.pos.y||48<=a.pos.y)&&1E3<=a.hitsMax-a.hits}),function(a){a.say("Ouch!");g.canAssign(a);d.push(a.name)}),_.remove(c,function(a){return-1!==d.indexOf(a.name)}),d=[],0===c.length))break;0<n.length&&_.remove(c,function(a){return 1E3<=a.hitsMax-a.hits});if(l&&
(b=_.filter(l.find(FIND_HOSTILE_STRUCTURES),function(a){return!(a instanceof StructureController)&&!(a instanceof StructureRampart)&&!(a instanceof StructureKeeperLair)}),0<b.length&&(g=new TaskDismantle(b[0].id),_.forEach(c,function(a){g.canAssign(a)&&(a.say("Dismantle"),d.push(a.name))}),_.remove(c,function(a){return-1!==d.indexOf(a.name)}),d=[],0===c.length)))break;_.forEach(e.rally.tasks,function(a){_.forEach(c,function(b){a.canAssign(b);d.push(b.name);return!1});_.remove(c,function(a){return-1!==
d.indexOf(a.name)});d=[]});g=new TaskRally(f);_.forEach(c,function(a){g.canAssign(a)})}}};require("screeps-profiler").registerObject(Dismantler,"ArmyDismantler");module.exports=Dismantler;