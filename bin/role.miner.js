var $jscomp={scope:{},findInternal:function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(c.call(b,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskMine=require("task.mine"),TaskRally=require("task.rally"),Miner={checkSpawn:function(a){var c=a.name,b=Cache.containersInRoom(a),d=0,e;0!==Cache.spawnsInRoom(a).length&&0!==b.length&&(e=Cache.creeps[c]&&Cache.creeps[c].miner||[],_.forEach(b,function(b){var c=b.id;Memory.containerSource[c]||(Memory.containerSource[c]=Utilities.objectsClosestToObj([].concat.apply([],[a.find(FIND_SOURCES),a.find(FIND_MINERALS)]),b)[0].id);b=Game.getObjectById(Memory.containerSource[c]);
b instanceof Mineral&&0===b.mineralAmount||(d+=1,0===_.filter(e,function(a){return(a.spawning||150<=a.ticksToLive)&&a.memory.container===c}).length&&Miner.spawn(a,c))}),Memory.log&&(0<e.length||0<d)&&Cache.log.rooms[c].creeps.push({role:"miner",count:e.length,max:d}))},spawn:function(a,c){var b=Cache.spawnsInRoom(a),d=[MOVE,WORK,WORK,WORK,WORK,WORK],e=a.name,f,g;if(0===_.filter(b,function(a){return!a.spawning&&!Cache.spawning[a.id]}).length)return!1;f=Math.min(a.energyCapacityAvailable,4500);g=Math.floor(f/
450);f%=450;if(Utilities.objectsClosestToObj([].concat.apply([],[a.find(FIND_SOURCES),a.find(FIND_MINERALS)]),Game.getObjectById(c))[0]instanceof Mineral){d=[];for(a=0;a<g;a++)d.push(MOVE);50<=f&&d.push(MOVE);for(a=0;a<g;a++)d.push(WORK),d.push(WORK),d.push(WORK),d.push(WORK);150<=f&&d.push(WORK);250<=f&&d.push(WORK);350<=f&&d.push(WORK)}b=_.filter(b,function(a){return!a.spawning&&!Cache.spawning[a.id]&&a.room.energyAvailable>=Utilities.getBodypartCost(d)})[0];if(!b)return!1;c=b.createCreep(d,"miner-"+
e+"-"+Game.time.toFixed(0).substring(4),{role:"miner",home:e,container:c});Cache.spawning[b.id]="number"!==typeof c;return"number"!==typeof c},assignTasks:function(a,c){a=a.name;a=Utilities.creepsWithNoTask(Cache.creeps[a]&&Cache.creeps[a].miner||[]);var b=[];0!==a.length&&(_.forEach(_.filter(a,function(a){return a.memory.labs&&0<a.memory.labs.length}),function(a){(new TaskRally(a.memory.labs[0])).canAssign(a);b.push(a.name)}),_.remove(a,function(a){return-1!==b.indexOf(a.name)}),b=[],0!==a.length&&
_.forEach(a,function(a){(new TaskMine).canAssign(a)&&a.say("Mining")}))}};require("screeps-profiler").registerObject(Miner,"RoleMiner");module.exports=Miner;