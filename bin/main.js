var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,e={next:function(){if(c<a.length){var d=c++;return{value:b(d,a[d]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.values",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,c){return c})}},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var g=a[d];if(b.call(c,g,d,a))return{i:d,v:g}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
require("screeps-perf")({optimizePathFinding:!1,cleanUpCreepMemory:!1});
var profiler=require("screeps-profiler"),Army=require("army"),Cache=require("cache"),Commands=require("commands"),Drawing=require("drawing"),Market=require("market"),Minerals=require("minerals"),Utilities=require("utilities"),RoleArmyDismantler=require("role.armyDismantler"),RoleArmyHealer=require("role.armyHealer"),RoleArmyMelee=require("role.armyMelee"),RoleArmyRanged=require("role.armyRanged"),RoleClaimer=require("role.claimer"),RoleCollector=require("role.collector"),RoleDefender=require("role.defender"),
RoleDismantler=require("role.dismantler"),RoleHealer=require("role.healer"),RoleMiner=require("role.miner"),RoleRemoteBuilder=require("role.remoteBuilder"),RoleRemoteCollector=require("role.remoteCollector"),RoleRemoteDismantler=require("role.remoteDismantler"),RoleRemoteMiner=require("role.remoteMiner"),RoleRemoteReserver=require("role.remoteReserver"),RoleRemoteStorer=require("role.remoteStorer"),RoleRemoteWorker=require("role.remoteWorker"),RoleScientist=require("role.scientist"),RoleStorer=require("role.storer"),
RoleTower=require("role.tower"),RoleUpgrader=require("role.upgrader"),RoleWorker=require("role.worker"),RoomBase=require("room.base"),RoomCleanup=require("room.cleanup"),RoomMine=require("room.mine"),taskDeserialization=require("taskDeserialization"),roomDeserialization=require("roomDeserialization"),reset,unobservableRooms,main={loop:function(){Game.cpu.bucket<Game.cpu.tickLimit||profiler.wrap(function(){main.init();main.minerals();main.baseMatrixes();main.deserializeCreeps();main.deserializeRooms();
main.balanceEnergy();Memory.log&&main.log();main.rooms();main.army();main.creeps();main.finalize()})},init:function(){var a=Game.time%1500;Cache.reset();reset||(reset=!0,Cache.log.events.push("System reset."));Cache.credits<Memory.minimumCredits&&delete Memory.buy;Cache.credits>=1.5*Memory.minimumCredits&&(Memory.buy=!0);Game.cmd={Army:Army,Cache:Cache,Commands:Commands,Market:Market,Minerals:Minerals,Role:{ArmyDismantler:RoleArmyDismantler,ArmyHealer:RoleArmyHealer,ArmyMelee:RoleArmyMelee,ArmyRanged:RoleArmyRanged,
Claimer:RoleClaimer,Collector:RoleCollector,Defender:RoleDefender,Dismantler:RoleDismantler,Healer:RoleHealer,Miner:RoleMiner,RemoteBuilder:RoleRemoteBuilder,RemoteCollector:RoleRemoteCollector,RemoteDismantler:RoleRemoteDismantler,RemoteMiner:RoleRemoteMiner,RemoteReserver:RoleRemoteReserver,RemoteStorer:RoleRemoteStorer,RemoteWorker:RoleRemoteWorker,Scientist:RoleScientist,Storer:RoleStorer,Tower:RoleTower,Upgrader:RoleUpgrader,Worker:RoleWorker},Room:{Base:RoomBase,Cleanup:RoomCleanup,Mine:RoomMine},
Utilities:Utilities};Memory.maxCreeps||(Memory.maxCreeps={});Memory.containerSource||(Memory.containerSource={});Memory.army||(Memory.army={});Memory.avoidRooms||(Memory.avoidRooms=[]);Memory.avoidSquares||(Memory.avoidSquares={});Memory.paths||(Memory.paths={});Memory.lengthToStorage||(Memory.lengthToStorage={});Memory.towerTasks||(Memory.towerTasks={});Memory.stats||(Memory.stats={});Memory.stats.cpu||(Memory.stats.cpu=[]);Memory.stats.bucket||(Memory.stats.bucket=[]);Memory.stats.gclProgress||
(Memory.stats.gclProgress=[]);0===Game.time%10&&(_.forEach(Memory.creeps,function(a,c){Game.creeps[c]||delete Memory.creeps[c]}),_.forEach(Memory.lengthToContainer,function(a,c){Game.getObjectById(c)||delete Memory.lengthToContainer[c]}),_.forEach(Memory.lengthToController,function(a,c){Game.getObjectById(c)||delete Memory.lengthToController[c]}),_.forEach(Memory.lengthToStorage,function(a,c){Game.getObjectById(c)||delete Memory.lengthToStorage[c]}),_.forEach(Memory.containerSource,function(a,c){Game.getObjectById(c)||
delete Memory.containerSource[c]}),_.forEach(Memory.dismantle,function(a,c){0===a.length&&delete Memory.dismantle[c]}),_.forEach(Memory.rooms,function(a,c){a&&a.roomType||delete Memory.rooms[c]}),_.forEach(Memory.maxCreeps,function(a,c){_.forEach(Memory.maxCreeps[c],function(b,c){0===Object.keys(b).length&&delete a[c]})}),_.forEach(Memory.paths,function(a,c){a.lastUsed<=Game.time-500&&delete Memory.paths[c]}));delete Memory.flags;switch(a){case 0:delete Memory.lengthToStorage;Memory.lengthToStorage=
{};break;case 100:delete Memory.lengthToContainer;Memory.lengthToContainer={};break;case 200:delete Memory.lengthToController;Memory.lengthToController={};break;case 300:delete Memory.ranges;Memory.ranges={};break;case 400:delete Memory.paths,Memory.paths={}}Cache.creeps=Utilities.nest(_.filter(Game.creeps,function(a){return a.memory.home}),[function(a){return a.memory.home},function(a){return a.memory.role}]);_.forEach(Cache.creeps,function(a,c){Cache.creeps[c].all=_.flatten(_.values(a))})},minerals:function(){var a=
{},b,c;Game.cpu.bucket>=Memory.marketBucket&&(b=[{resource:RESOURCE_HYDROGEN,amount:3E3},{resource:RESOURCE_OXYGEN,amount:3E3},{resource:RESOURCE_ZYNTHIUM,amount:3E3},{resource:RESOURCE_KEANIUM,amount:3E3},{resource:RESOURCE_UTRIUM,amount:3E3},{resource:RESOURCE_LEMERGIUM,amount:3E3},{resource:RESOURCE_CATALYST,amount:3E3},{resource:RESOURCE_HYDROXIDE,amount:3E3},{resource:RESOURCE_ZYNTHIUM_KEANITE,amount:3E3},{resource:RESOURCE_UTRIUM_LEMERGITE,amount:3E3},{resource:RESOURCE_GHODIUM,amount:3E3},
{resource:RESOURCE_UTRIUM_HYDRIDE,amount:3E3},{resource:RESOURCE_KEANIUM_OXIDE,amount:3E3},{resource:RESOURCE_LEMERGIUM_HYDRIDE,amount:3E3},{resource:RESOURCE_LEMERGIUM_OXIDE,amount:3E3},{resource:RESOURCE_ZYNTHIUM_HYDRIDE,amount:3E3},{resource:RESOURCE_GHODIUM_HYDRIDE,amount:3E3},{resource:RESOURCE_GHODIUM_OXIDE,amount:3E3},{resource:RESOURCE_UTRIUM_ACID,amount:3E3},{resource:RESOURCE_KEANIUM_ALKALIDE,amount:3E3},{resource:RESOURCE_LEMERGIUM_ACID,amount:3E3},{resource:RESOURCE_LEMERGIUM_ALKALIDE,
amount:3E3},{resource:RESOURCE_ZYNTHIUM_ACID,amount:3E3},{resource:RESOURCE_GHODIUM_ACID,amount:3E3},{resource:RESOURCE_GHODIUM_ALKALIDE,amount:3E3},{resource:RESOURCE_CATALYZED_UTRIUM_ACID,amount:15E3},{resource:RESOURCE_CATALYZED_KEANIUM_ALKALIDE,amount:15E3},{resource:RESOURCE_CATALYZED_LEMERGIUM_ACID,amount:15E3},{resource:RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,amount:15E3},{resource:RESOURCE_CATALYZED_ZYNTHIUM_ACID,amount:15E3},{resource:RESOURCE_CATALYZED_GHODIUM_ACID,amount:15E3},{resource:RESOURCE_CATALYZED_GHODIUM_ALKALIDE,
amount:15E3}],_.forEach(b,function(a){var c=function(a,c){a.children=_.map(Minerals[a.resource],function(a){return{resource:a}});_.forEach(a.children,function(b){b.amount=a.amount;c(b,c)})};c(a,c)}),Memory.reserveMinerals={},_.forEach(b,function(a){var c=function(a,c){Memory.reserveMinerals[a.resource]||(Memory.reserveMinerals[a.resource]=0);Memory.reserveMinerals[a.resource]=Math.min(Memory.reserveMinerals[a.resource]+a.amount,2E4);_.forEach(a.children,function(a){c(a,c)})};c(a,c)}),_.forEach(_.uniq(_.map(Market.getAllOrders(),
function(a){return a.resourceType})),function(b){(c=(Market.getFilteredOrders().sell[b]||[])[0])&&(a[b]=c)}),_.forEach(Game.rooms,function(c,d){var e=Infinity,h=c.memory,f=Cache.creeps[d]&&Cache.creeps[d].all,m;!c.unobservable&&c.storage&&c.terminal&&c.terminal.my&&c.memory.roomType&&"base"===c.memory.roomType.type&&!(3>Cache.labsInRoom(c))&&(Cache.minerals[d]=_.cloneDeep(b),delete h.use,_.forEach(Cache.minerals[d],function(b){var l=function(b,l){var d,k=b.resource,n=(c.storage.store[k]||0)+(c.terminal.store[k]||
0)+_.sum(f,function(a){return a.carry[k]||0});b.buyPrice=a[k]?a[k].price:Infinity;b.amount=Math.max(b.amount-n,0);_.forEach(b.children,function(a){l(a,l)});if(b.children&&0!==b.children.length)if(d=_.sum(_.map(b.children,function(a){return a.buyPrice})),b.buyPrice>d){var g=5*Math.floor(((c.storage.store[b.children[0].resource]||0)+(c.terminal.store[b.children[0].resource]||0)+_.sum(f,function(a){return a.carry[b.children[0].resource]||0}))/5),p=5*Math.floor(((c.storage.store[b.children[1].resource]||
0)+(c.terminal.store[b.children[1].resource]||0)+_.sum(f,function(a){return a.carry[b.children[1].resource]||0}))/5);b.amount=Math.min(Math.min(b.amount,g),p);b.action="create";b.buyPrice=d;n<=e&&0<b.amount&&(m=b,e=n)}else b.action="buy";else b.action="buy";0<b.amount&&"buy"===b.action&&!h.buyQueue&&Cache.credits>=Memory.minimumCredits&&Memory.buy&&(h.buyQueue={resource:k,amount:b.amount,price:b.buyPrice,start:Game.time});b.buyPrice&&(Memory.minimumSell[k]=Math.min(Memory.minimumSell[k]||Infinity,
b.buyPrice),0!==Memory.minimumSell[k]&&Infinity!==Memory.minimumSell[k]||delete Memory.minimumSell[k])};l(b,l)}),m&&!h.labQueue&&(d=function(a,b){var l=a.resource,d;if(!(0>=a.amount)&&"create"===a.action){d=5*Math.floor(((c.storage.store[a.children[0].resource]||0)+(c.terminal.store[a.children[0].resource]||0)+_.sum(f,function(b){return b.carry[a.children[0].resource]||0}))/5);var e=5*Math.floor(((c.storage.store[a.children[1].resource]||0)+(c.terminal.store[a.children[1].resource]||0)+_.sum(f,function(b){return b.carry[a.children[1].resource]||
0}))/5);h.labQueue={resource:l,amount:Math.min(5*Math.ceil(Math.min(Math.min(Math.min(a.amount,d),e),LAB_MINERAL_CAPACITY)/5),3E3),children:_.map(a.children,function(a){return a.resource}),start:Game.time};_.forEach(a.children,function(a){b(a,b)});d=_.sum(a.children,function(a){return a.price});0<a.children.length&&0<d&&(Memory.minimumSell[l]=Math.min(Memory.minimumSell[l]||Infinity,d),0===Memory.minimumSell[l]&&delete Memory.minimumSell[l])}},d(m,d)))}))},baseMatrixes:function(){Memory.baseMatrixes||
(Memory.baseMatrixes={});_.forEach(Memory.baseMatrixes,function(a,b){var c=Game.rooms[b],e,d,g;if(c&&!c.unobservable&&"complete"!==a.status&&0!==Cache.spawnsInRoom(c).length&&(g=Cache.repairableStructuresInRoom(c),a.status||(d=new PathFinder.CostMatrix,_.forEach(_.filter(g,function(a){return a.structureType!==STRUCTURE_ROAD}),function(a){d.set(a.pos.x,a.pos.y,255)}),a.tempMatrix=d.serialize(),a.costMatrix=d.serialize(),a.status="building",a.x=0,a.y=0),"building"===a.status)){e=PathFinder.CostMatrix.deserialize(a.tempMatrix);
for(d=PathFinder.CostMatrix.deserialize(a.costMatrix);50>a.x;a.x++){for(;50>a.y;a.y++){if(250<=Game.cpu.getUsed())return a.costMatrix=d.serialize(),!1;PathFinder.search(new RoomPosition(a.x,a.y,b),{pos:Cache.spawnsInRoom(c)[0].pos,range:1},{roomCallback:function(){return e},maxOps:1E4,maxRooms:1}).incomplete&&d.set(a.x,a.y,255)}a.y=0}_.forEach(_.filter(g,function(a){return a.structureType===STRUCTURE_RAMPART}),function(a){d.set(a.pos.x,a.pos.y,0)});delete a.tempMatrix;delete a.x;delete a.y;a.costMatrix=
d.serialize();a.status="complete"}})},deserializeCreeps:function(){_.forEach(Game.creeps,function(a){a.memory.currentTask&&taskDeserialization(a)})},deserializeRooms:function(){unobservableRooms=[];_.forEach(Memory.rooms,function(a,b){a.roomType&&(roomDeserialization(a,b),Game.rooms[b]||unobservableRooms.push({name:b,unobservable:!0}))})},balanceEnergy:function(){var a,b;a=_.filter(Game.rooms,function(a){return a.memory&&a.memory.roomType&&"base"===a.memory.roomType.type&&a.storage&&a.terminal}).sort(function(a,
b){return a.storage.store[RESOURCE_ENERGY]+a.terminal.store[RESOURCE_ENERGY]-(b.storage.store[RESOURCE_ENERGY]+b.terminal.store[RESOURCE_ENERGY])});1<a.length&&(b=Math.min(_.sum(_.map(a,function(a){return a.storage.store[RESOURCE_ENERGY]+a.terminal.store[RESOURCE_ENERGY]}))/a.length,5E5),_.forEach(a,function(c,e){e=a[a.length-e-1];var d=c.storage.store[RESOURCE_ENERGY],g=e.storage.store[RESOURCE_ENERGY],h=e.terminal,f=h.store[RESOURCE_ENERGY];if(d>=g||d+c.terminal.store[RESOURCE_ENERGY]>b||g+f<b+
1E4)return!1;1E3<=f&&(d=Game.market.calcTransactionCost(f,e.name,c.name),h.send(RESOURCE_ENERGY,Math.floor(f/(f+d)*f),c.name),Cache.log.events.push("Sending "+Math.floor(f/(f+d)*f)+" energy from "+e.name+" to "+c.name))}))},log:function(){Cache.log.creeps=_.map(Game.creeps,function(a){return{creepId:a.id,name:a.name,creepType:a.memory.role,home:a.memory.home,army:a.memory.army,room:a.pos.roomName,x:a.pos.x,y:a.pos.y,spawning:a.spawning,ttl:a.ticksToLive,carryCapacity:a.carryCapacity,carry:a.carry,
hits:a.hits,hitsMax:a.hitsMax}});Cache.log.spawns=_.map(Game.spawns,function(a){return{spawnId:a.id,name:a.name,room:a.room.name,spawningName:a.spawning?a.spawning.name:void 0,spawningNeedTime:a.spawning?a.spawning.needTime:void 0,spawningRemainingTime:a.spawning?a.spawning.remainingTime:void 0}});_.forEach([].concat.apply([],[_.filter(Game.rooms),unobservableRooms]),function(a){var b=a.name,c=Memory.rooms[b],e=c&&c.roomType&&c.roomType.type?c.roomType.type:"unknown",d,g,h,f,m,n;a.unobservable?Cache.log.rooms[b]=
{type:e,supportRoom:c&&c.roomType?c.roomType.supportRoom:void 0,region:c?c.region:void 0,unobservable:!0,store:{},labs:[],source:[],creeps:[]}:(0===Game.time%10&&(d=Cache.repairableStructuresInRoom(a)),g=a.find(FIND_MY_CONSTRUCTION_SITES),h=Cache.towersInRoom(a),f=Cache.labsInRoom(a),m=Cache.nukersInRoom(a),n=Cache.powerSpawnsInRoom(a),Cache.log.rooms[b]={type:e,supportRoom:c&&c.roomType?c.roomType.supportRoom:void 0,region:c?c.region:void 0,unobservable:!1,controller:!!a.controller,store:{},labs:[],
source:[],creeps:[]},Cache.log.rooms[b].controller&&(Cache.log.rooms[b].rcl=a.controller.level,a.controller.owner&&(Cache.log.rooms[b].ownerUsername=a.controller.owner.username),Cache.log.rooms[b].progress=a.controller.progress,Cache.log.rooms[b].progressTotal=a.controller.progressTotal,Cache.log.rooms[b].ttd=a.controller.ticksToDowngrade),a.controller&&a.controller.reservation&&(Cache.log.rooms[b].reservedUsername=a.controller.reservation.username,Cache.log.rooms[b].tte=a.controller.reservation.ticksToEnd),
Cache.log.rooms[b].lowestWall=0===Game.time%10?Math.min.apply(Math,_.map(_.filter(d,function(a){return a.structureType===STRUCTURE_WALL||a.structureType===STRUCTURE_RAMPART}),function(a){return a.hits})):Memory.console&&Memory.console.rooms&&Memory.console.rooms[b]&&Memory.console.rooms[b].lowestWall||null,a.energyCapacityAvailable&&0<a.energyCapacityAvailable&&(Cache.log.rooms[b].energyAvailable=a.energyAvailable,Cache.log.rooms[b].energyCapacityAvailable=a.energyCapacityAvailable),Cache.log.rooms[b].constructionProgress=
_.sum(_.map(g,function(a){return a.progress})),Cache.log.rooms[b].constructionProgressTotal=_.sum(_.map(g,function(a){return a.progressTotal})),Cache.log.rooms[b].towerEnergy=_.sum(_.map(h,function(a){return a.energy})),Cache.log.rooms[b].towerEnergyCapacity=_.sum(_.map(h,function(a){return a.energyCapacity})),Cache.log.rooms[b].labEnergy=_.sum(_.map(f,function(a){return a.energy})),Cache.log.rooms[b].labEnergyCapacity=_.sum(_.map(f,function(a){return a.energyCapacity})),Cache.log.rooms[b].nukerEnergy=
_.sum(_.map(m,function(a){return a.energy})),Cache.log.rooms[b].nukerEnergyCapacity=_.sum(_.map(m,function(a){return a.energyCapacity})),Cache.log.rooms[b].nukerGhodium=_.sum(_.map(m,function(a){return a.ghodium})),Cache.log.rooms[b].nukerGhodiumCapacity=_.sum(_.map(m,function(a){return a.ghodiumCapacity})),Cache.log.rooms[b].powerSpawnEnergy=_.sum(_.map(n,function(a){return a.energy})),Cache.log.rooms[b].powerSpawnEnergyCapacity=_.sum(_.map(n,function(a){return a.energyCapacity})),Cache.log.rooms[b].powerSpawnPower=
_.sum(_.map(n,function(a){return a.power})),Cache.log.rooms[b].powerSpawnPowerCapacity=_.sum(_.map(n,function(a){return a.powerCapacity})),a.storage&&(Cache.log.rooms[b].store.storage=_.map(a.storage.store,function(a,b){return{resource:b,amount:a}})),a.terminal&&(Cache.log.rooms[b].store.terminal=_.map(a.terminal.store,function(a,b){return{resource:b,amount:a}})),Cache.log.rooms[b].labs=_.map(f,function(a){return{resource:a.mineralType,amount:a.mineralAmount}}),Cache.log.rooms[b].labQueue=c.labQueue,
Cache.log.rooms[b].buyQueue=c.buyQueue,_.forEach(a.find(FIND_SOURCES),function(a){Cache.log.rooms[b].source.push({sourceId:a.id,resource:RESOURCE_ENERGY,amount:a.energy,capacity:a.energyCapacity,ttr:a.ticksToRegeneration})}),_.forEach(a.find(FIND_MINERALS),function(a){Cache.log.rooms[b].source.push({sourceId:a.id,resource:a.mineralType,amount:a.mineralAmount,ttr:a.ticksToRegeneration})}),Cache.log.hostiles=[].concat.apply([],[Cache.log.hostiles,_.map(Cache.hostilesInRoom(a),function(a){return{creepId:a.id,
ownerUsername:a.owner.username,room:b,x:a.pos.x,y:a.pos.y,ttl:a.ticksToLive,hits:a.hits,hitsMax:a.hitsMax}})]))})},rooms:function(){Memory.rushRoom=(_.filter(Game.rooms,function(a){return a.memory&&a.memory.roomType&&"base"===a.memory.roomType.type&&a.controller&&8>a.controller.level}).sort(function(a,b){return b.controller.level-a.controller.level||b.controller.progress-a.controller.progress})[0]||{name:""}).name;_.forEach([].concat.apply([],[_.filter(Game.rooms),unobservableRooms]).sort(function(a,
b){return["base","source","mine","cleanup",""].indexOf(Memory.rooms[a.name]&&Memory.rooms[a.name].roomType&&Memory.rooms[a.name].roomType.type||"")-["base","source","mine","cleanup",""].indexOf(Memory.rooms[b.name]&&Memory.rooms[b.name].roomType&&Memory.rooms[b.name].roomType.type||"")}),function(a){var b=a.name,c=Memory.rooms[b];Cache.roomTypes[b]&&((5E3<=Game.cpu.bucket||0===Game.time%2)&&Cache.roomTypes[b].run(a),c&&c.roomType&&c.roomType.type===Cache.roomTypes[b].type&&Cache.roomTypes[b].toObj(a));
a.unobservable||main.drawRoom(a)})},drawRoom:function(a){Memory.visualizations&&(a.visual.text("GCL "+Game.gcl.level,-.5,.1,{align:"left"}),Drawing.progressBar(a,2.5,-.4,20,.5,Game.gcl.progress,Game.gcl.progressTotal,{background:"#808080",bar:"#00ff00",showDetails:!0,color:"#ffffff"}),Drawing.progressBar(a,34.5,-.4,10,.5,Game.cpu.bucket,1E4,{label:"Bucket",background:"#808080",showMax:!1,bar:9990<=Game.cpu.bucket?"#00ffff":9E3<=Game.cpu.bucket?"#00ff00":5E3<=Game.cpu.bucket?"#cccc00":"#ff0000",color:"#ffffff"}),
a.visual.text("Tick "+Game.time,49.5,.1,{align:"right"}),a.visual.text("Credits "+Game.market.credits.toFixed(2),-.5,.8,{align:"left"}),a.visual.text(Cache.time,49.5,.8,{align:"right"}),a.memory&&a.memory.roomType&&a.visual.text(_.capitalize(a.memory.roomType.type),-.5,49.4,{align:"left"}),a.controller&&a.controller.progress&&a.controller.progressTotal&&(a.visual.text("RCL "+a.controller.level,2.5,49.4,{align:"left"}),Drawing.progressBar(a,5.5,48.9,20,.5,a.controller.progress,a.controller.progressTotal,
{background:"#808080",bar:"#00ff00",showDetails:!0,color:"#ffffff"})))},army:function(){_.forEach(Memory.army,function(a,b){Cache.log.army[b]={directive:a.directive,scheduled:a.scheduled,portals:a.portals,boostRoom:a.boostRoom,buildRoom:a.buildRoom,stageRoom:a.stageRoom,attackRoom:a.attackRoom,dismantle:a.dismantle.length,creeps:[]};Game.rooms[a.attackRoom]&&(Cache.log.army[b].structures=_.filter(Game.rooms[Memory.army[b].attackRoom].find(FIND_HOSTILE_STRUCTURES),function(a){return a.structureType!==
STRUCTURE_CONTROLLER&&a.structureType!==STRUCTURE_RAMPART&&a.structureType!==STRUCTURE_KEEPER_LAIR}).length,Cache.log.army[b].constructionSites=Game.rooms[Memory.army[b].attackRoom].find(FIND_HOSTILE_CONSTRUCTION_SITES).length);Army.run(b)})},creeps:function(){_.forEach(Game.creeps,function(a){if(!a.spawning&&!a.memory.stop){if(150>=a.ticksToLive||500>a.ticksToLive&&1===a.ticksToLive%10||1===a.ticksToLive%100)switch(a.ticksToLive-1){case 3:a.say("R.I.P. and",!0);break;case 2:a.say("Pepperonis",!0);
break;case 1:a.say(":(",!0);break;default:a.say("TTL "+(a.ticksToLive-1).toString())}a.memory.army&&Memory.army[a.memory.army]&&a.room.name===Memory.army[a.memory.army].attackRoom&&a.say("All my friends are heathens, take it slow.  Wait for them to ask you who you know.  Please don't make any sudden moves.  You don't know the half of the abuse. ".split(" ")[Game.time%35],!0);switch(Game.time%1E6){case 999990:a.say("TEN!",!0);break;case 999991:a.say("NINE!",!0);break;case 999992:a.say("EIGHT!",!0);
break;case 999993:a.say("SEVEN!",!0);break;case 999994:a.say("SIX!",!0);break;case 999995:a.say("FIVE!",!0);break;case 999996:a.say("FOUR!",!0);break;case 999997:a.say("THREE!",!0);break;case 999998:a.say("TWO!",!0);break;case 999999:a.say("ONE!",!0);break;case 0:a.say("HAPPY NEW",!0);break;case 1:a.say("MILLION!",!0)}if(a.memory.currentTask&&Cache.creepTasks[a.name]){if(0===a.pos.x)switch(Math.floor(3*Math.random())){case 0:a.move(RIGHT);break;case 1:a.move(TOP_RIGHT);break;case 2:a.move(BOTTOM_RIGHT)}if(49===
a.pos.x)switch(Math.floor(3*Math.random())){case 0:a.move(LEFT);break;case 1:a.move(TOP_LEFT);break;case 2:a.move(BOTTOM_LEFT)}if(0===a.pos.y)switch(Math.floor(3*Math.random())){case 0:a.move(BOTTOM);break;case 1:a.move(BOTTOM_RIGHT);break;case 2:a.move(BOTTOM_LEFT)}if(49===a.pos.y)switch(Math.floor(3*Math.random())){case 0:a.move(TOP);break;case 1:a.move(TOP_RIGHT);break;case 2:a.move(TOP_LEFT)}Cache.creepTasks[a.name].run(a);!a.memory.lastRoom||a.memory.lastRoom===a.room.name||a.memory.currentTask&&
a.memory.currentTask.force||delete a.memory.currentTask;a.memory.lastRoom=a.room.name;a.memory.currentTask&&Cache.creepTasks[a.name]&&Cache.creepTasks[a.name].toObj(a);0<a.carry[RESOURCE_ENERGY]&&0<a.getActiveBodyparts(WORK)&&_.forEach(_.filter(a.pos.lookFor(LOOK_STRUCTURES),function(a){return a.structureType===STRUCTURE_ROAD&&a.hits<a.hitsMax}),function(b){a.repair(b)})}else delete a.memory.currentTask,!a.spawning&&150>a.ticksToLive&&-1==="armyDismantler armyHealer armyMelee armyRanged claimer defender healer remoteReserver".split(" ").indexOf(a.memory.role)&&
a.suicide()}})},finalize:function(){Cache.log.tick=Game.time;Cache.log.date=new Date;Cache.log.gcl=Game.gcl.level;Cache.log.progress=Game.gcl.progress;Cache.log.progressTotal=Game.gcl.progressTotal;Cache.log.limit=Game.cpu.limit;Cache.log.tickLimit=Game.cpu.tickLimit;Cache.log.bucket=Game.cpu.bucket;Cache.log.credits=Game.market.credits;for(Memory.stats.cpu.push(Game.cpu.getUsed());100<Memory.stats.cpu.length;)Memory.stats.cpu.shift();for(Memory.stats.bucket.push(Cache.log.bucket);100<Memory.stats.bucket.length;)Memory.stats.bucket.shift();
for(Memory.stats.gclProgress.push(Cache.log.progress);100<Memory.stats.gclProgress.length;)Memory.stats.gclProgress.shift();Memory.visualizations&&_.forEach(Game.rooms,function(a){Drawing.sparkline(a,23.5,1,20,2,_.map(Memory.stats.cpu,function(a,c){return{cpu:Memory.stats.cpu[c],bucket:Memory.stats.bucket[c],limit:Game.cpu.limit}}),[{key:"limit",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#808080",opacity:.25},{key:"cpu",min:.5*Game.cpu.limit,max:1.5*Game.cpu.limit,stroke:"#ffff00",opacity:.5},
{key:"bucket",min:0,max:1E4,stroke:"#00ffff",opacity:.5}])});Cache.log.cpuUsed=Game.cpu.getUsed();Memory.stats.cpu[Memory.stats.cpu.length-1]=Cache.log.cpuUsed;Memory.console=Cache.log;Memory.visualizations&&_.forEach(Game.rooms,function(a){Drawing.progressBar(a,23.5,-.4,10,.5,Cache.log.cpuUsed,Game.cpu.limit,{label:"CPU",background:"#808080",valueDecimals:2,bar:Cache.log.cpuUsed>Game.cpu.limit?"#ff0000":"#00ff00",color:"#ffffff"})})}};profiler.registerObject(main,"main");Memory.profiling&&profiler.enable();
module.exports=main;