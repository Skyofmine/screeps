var $jscomp={scope:{},findInternal:function(c,e,f){c instanceof String&&(c=String(c));for(var g=c.length,a=0;a<g;a++){var h=c[a];if(e.call(f,h,a,c))return{i:a,v:h}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(c,e,f){if(f.get||f.set)throw new TypeError("ES3 does not support getters and setters.");c!=Array.prototype&&c!=Object.prototype&&(c[e]=f.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,e,f,g){if(e){f=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var a=c[g];a in f||(f[a]={});f=f[a]}c=c[c.length-1];g=f[c];e=e(g);e!=g&&null!=e&&$jscomp.defineProperty(f,c,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,f){return $jscomp.findInternal(this,c,f).v}},"es6-impl","es3");
var Cache=require("cache"),Utilities=require("utilities"),TaskHarvest=require("task.harvest"),TaskPickupResource=require("task.pickupResource"),TaskRally=require("task.rally"),Worker={checkSpawn:function(c,e){var f=c.name,g=Cache.creeps[f]&&Cache.creeps[f].worker||[],a=c.storage,h;0!==c.find(FIND_SOURCES).length&&(h=_.filter(g,function(c){return c.spawning||c.ticksToLive>=(a?150:300)}).length,e=e?a?1:2:0,h<e&&Worker.spawn(c),Memory.log&&(0<g.length||0<e)&&Cache.log.rooms[f].creeps.push({role:"worker",
count:g.length,max:e}),_.forEach(_.filter(Game.rooms,function(a){return a.memory&&a.memory.roomType&&"base"===a.memory.roomType.type&&a.memory.region===c.memory.region&&a.name!==f&&a.controller&&a.controller.my&&6>a.controller.level}),function(a){0===_.filter(Cache.creeps[a.name]&&Cache.creeps[a.name].worker||[],function(a){return a.memory.supportRoom!==a.memory.home}).length&&Worker.spawn(a,c)}))},spawn:function(c,e){var f=[],g=0,a=!1,h=c.name,k,d,b,n,l,m,p;e||(e=c);k=e.name;d=Cache.spawnsInRoom(e);
b=e.storage;if(0!==d.length){if(3<=Cache.labsInRoom(e).length&&0===_.filter(d,function(b){return!b.spawning&&!Cache.spawning[b.id]}).length)return!1;n=Math.min(e.energyCapacityAvailable,3300);l=Math.floor(n/200);n%=200;for(m=0;m<l;m++)f.push(WORK),g++;150<=n&&(f.push(WORK),g++);for(m=0;m<l;m++)f.push(CARRY);100<=n&&150>n&&f.push(CARRY);for(m=0;m<l;m++)f.push(MOVE);50<=n&&f.push(MOVE);(h===k||0<c.find(FIND_MY_CONSTRUCTION_SITES).length)&&0<g&&b&&0<Cache.labsInRoom(e).length&&Math.max(b.store[RESOURCE_LEMERGIUM_HYDRIDE]||
0,b.store[RESOURCE_LEMERGIUM_ACID]||0,b.store[RESOURCE_CATALYZED_LEMERGIUM_ACID]||0)>=30*g&&(a=!!(p=Utilities.getLabToBoostWith(e)[0]));l=3>Cache.labsInRoom(e).length?_.filter(Game.spawns,function(b){return!b.spawning&&!Cache.spawning[b.id]&&b.room.energyAvailable>=Utilities.getBodypartCost(f)&&b.room.memory.region===e.memory.region}).sort(function(b,a){return(b.room.name===k?0:1)-(a.room.name===k?0:1)})[0]:_.filter(d,function(b){return!b.spawning&&!Cache.spawning[b.id]&&b.room.energyAvailable>=Utilities.getBodypartCost(f)})[0];
if(!l)return!1;c=l.createCreep(f,"worker-"+h+"-"+Game.time.toFixed(0).substring(4),{role:"worker",home:h,supportRoom:k,homeSource:Utilities.objectsClosestToObj(c.find(FIND_SOURCES),d[0])[0].id,labs:a?[p.id]:[]});Cache.spawning[l.id]="number"!==typeof c;"number"!==typeof c&&a&&(p.creepToBoost=c,p.resource=b.store[RESOURCE_CATALYZED_LEMERGIUM_ACID]>=30*g?RESOURCE_CATALYZED_LEMERGIUM_ACID:b.store[RESOURCE_LEMERGIUM_ACID]>=30*g?RESOURCE_LEMERGIUM_ACID:RESOURCE_LEMERGIUM_HYDRIDE,p.amount=30*g,e.memory.labsInUse.push(p),
_.forEach(_.filter(Cache.creeps[e.name]&&Cache.creeps[e.name].all||[],function(b){return b.memory.currentTask&&"fillMinerals"===b.memory.currentTask.type&&b.memory.currentTask.id===p.id}),function(b){delete b.memory.currentTask}));return"number"!==typeof c}},assignTasks:function(c,e){var f=c.name,g=Cache.creeps[f]&&Cache.creeps[f].worker||[],a=_.filter(Utilities.creepsWithNoTask(g),function(b){return 0<_.sum(b.carry)||!b.spawning&&150<b.ticksToLive}),h=Cache.creeps[f]&&Cache.creeps[f].all||[],f=Cache.creeps[f]&&
Cache.creeps[f].storer||[],k=c.controller,d=[];if(0!==a.length&&(_.forEach(_.filter(a,function(b){return b.memory.labs&&0<b.memory.labs.length}),function(b){var a=_.filter(Memory.rooms[b.memory.supportRoom].labsInUse,function(a){return a.id===b.memory.labs[0]})[0];a&&Game.getObjectById(b.memory.labs[0]).mineralType===a.resource&&Game.getObjectById(b.memory.labs[0]).mineralAmount>=a.amount&&((new TaskRally(b.memory.labs[0])).canAssign(b),d.push(b.name))}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),
d=[],0!==a.length)){if(!k||6>k.level)if(0===Cache.hostilesInRoom(c).length&&_.forEach(a,function(b){_.forEach(TaskPickupResource.getTasks(b.room),function(a){if(!(0<_.filter(a.resource.room.find(FIND_MY_CREEPS),function(b){return b.memory.currentTask&&"pickupResource"===b.memory.currentTask.type&&b.memory.currentTask.id===a.id}).length)&&a.canAssign(b))return b.say("Pickup"),d.push(b.name),!1})}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[],0===a.length)return;_.forEach(e.fillMinerals.storageTasks,
function(b){_.forEach(a,function(a){b.canAssign(a)&&(a.say("Storage"),d.push(a.name))});_.remove(a,function(b){return-1!==d.indexOf(b.name)});d=[]});if(0!==a.length&&(_.forEach(e.fillMinerals.terminalTasks,function(b){_.forEach(a,function(a){b.canAssign(a)&&(a.say("Terminal"),d.push(a.name))});_.remove(a,function(b){return-1!==d.indexOf(b.name)});d=[]}),0!==a.length&&(_.forEach(e.upgradeController.criticalTasks,function(b){0===_.filter(g,function(a){return a.memory.currentTask&&"upgradeController"===
a.memory.currentTask.type&&a.memory.currentTask.room===b.room}).length&&(_.forEach(Utilities.objectsClosestToObj(a,k),function(a){if(b.canAssign(a))return a.say("CritCntrlr"),d.push(a.name),!1}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[])}),0!==a.length))){if(!c.storage||0===f.length)if(_.forEach(a,function(b){b.carry[RESOURCE_ENERGY]<(8===c.controller.level?200:7===c.controller.level?100:50)||_.forEach(e.fillEnergy.extensionTasks.sort(function(a,l){return a.object.pos.getRangeTo(b)-
l.object.pos.getRangeTo(b)}),function(a){if(0<a.object.energyCapacity-a.object.energy-_.reduce(_.filter(h,function(b){return b.memory.currentTask&&"fillEnergy"===b.memory.currentTask.type&&b.memory.currentTask.id===a.id}),function(b,a){return b+(a.carry[RESOURCE_ENERGY]||0)},0)&&a.canAssign(b))return b.say("Extension"),d.push(b.name),!1})}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[],0===a.length)return;c.storage&&0!==f.length||_.forEach(e.fillEnergy.spawnTasks,function(b){var c=b.object.energyCapacity-
b.object.energy-_.reduce(_.filter(h,function(a){return a.memory.currentTask&&"fillEnergy"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(b,a){return b+(a.carry[RESOURCE_ENERGY]||0)},0);0<c&&(_.forEach(Utilities.objectsClosestToObj(a,b.object),function(a){if(b.canAssign(a)&&(a.say("Spawn"),d.push(a.name),c-=a.carry[RESOURCE_ENERGY]||0,0>=c))return!1}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[])});if(0!==a.length&&(_.forEach(e.fillEnergy.towerTasks,function(b){var c=
b.object.energyCapacity-b.object.energy-_.reduce(_.filter(h,function(a){return a.memory.currentTask&&"fillEnergy"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(b,a){return b+(a.carry[RESOURCE_ENERGY]||0)},0);0<c&&(_.forEach(Utilities.objectsClosestToObj(a,b.object),function(a){if(b.canAssign(a)&&(a.say("Tower"),d.push(a.name),c-=a.carry[RESOURCE_ENERGY]||0,0>=c))return!1}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[])}),0!==a.length&&(_.forEach(_.filter(e.build.tasks,
function(b){return 1===b.constructionSite.progressTotal}),function(b){var c=b.constructionSite.progressTotal-b.constructionSite.progress-_.reduce(_.filter(b.constructionSite.room.find(FIND_MY_CREEPS),function(a){return a.memory.currentTask&&"build"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(b,a){return b+(a.carry[RESOURCE_ENERGY]||0)},0);0<c&&(_.forEach(Utilities.objectsClosestToObj(a,b.constructionSite),function(a){if(b.canAssign(a)&&(a.say("Build"),d.push(a.name),c-=
a.carry[RESOURCE_ENERGY]||0,0>=c))return!1}),_.remove(a,function(b){return-1!==d.indexOf(b.name)}),d=[])}),0!==a.length&&(_.forEach(e.repair.criticalTasks,function(b){_.forEach(Utilities.objectsClosestToObj(a,b.structure),function(a){if(0===_.filter(b.structure.room.find(FIND_MY_CREEPS),function(a){return a.memory.currentTask&&"repair"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}).length&&b.canAssign(a))return a.say("CritRepair"),d.push(a.name),!1});_.remove(a,function(a){return-1!==
d.indexOf(a.name)});d=[]}),0!==a.length&&(_.forEach(e.build.tasks,function(b){var c=b.constructionSite.progressTotal-b.constructionSite.progress-_.reduce(_.filter(b.constructionSite.room.find(FIND_MY_CREEPS),function(a){return a.memory.currentTask&&"build"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(a,b){return a+(b.carry[RESOURCE_ENERGY]||0)},0);0<c&&(_.forEach(Utilities.objectsClosestToObj(a,b.constructionSite),function(a){if(b.canAssign(a)&&(a.say("Build"),d.push(a.name),
c-=a.carry[RESOURCE_ENERGY]||0,0>=c))return!1}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[])}),0!==a.length&&(_.forEach(e.repair.tasks,function(b){var c=b.structure.hitsMax-b.structure.hits-100*_.reduce(_.filter(b.structure.room.find(FIND_MY_CREEPS),function(a){return a.memory.currentTask&&"repair"===a.memory.currentTask.type&&a.memory.currentTask.id===b.id}),function(a,b){return a+(b.carry[RESOURCE_ENERGY]||0)},0),e=!1;if(0<c)return _.forEach(Utilities.objectsClosestToObj(a,b.structure),
function(a){if(b.canAssign(a)&&(a.say("Repair"),d.push(a.name),c-=100*(a.carry[RESOURCE_ENERGY]||0),e=!0,0>=c))return!1}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[],e}),0!==a.length)))))){if(k&&8>k.level&&(_.forEach(e.upgradeController.tasks,function(b){_.forEach(Utilities.objectsClosestToObj(a,c.controller),function(a){b.canAssign(a)&&(a.say("Controller"),d.push(a.name))});_.remove(a,function(a){return-1!==d.indexOf(a.name)});d=[]}),0===a.length))return;e.collectEnergy.terminalTask&&
(_.forEach(a,function(a){e.collectEnergy.terminalTask.canAssign(a)&&(a.say("Collecting"),d.push(a.name))}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[]);_.forEach(e.collectEnergy.tasks,function(b){_.forEach(a,function(a){b.canAssign(a)&&(a.say("Collecting"),d.push(a.name))});_.remove(a,function(a){return-1!==d.indexOf(a.name)});d=[]});if(0!==a.length){if(0===_.filter(Cache.containersInRoom(c),function(a){return 0<a.energy}).length&&!c.storage&&(_.forEach(a,function(a){(new TaskHarvest).canAssign(a)&&
(a.say("Harvesting"),d.push(a.name))}),_.remove(a,function(a){return-1!==d.indexOf(a.name)}),d=[],0===a.length))return;_.forEach(TaskRally.getHarvesterTasks(a),function(a){a.canAssign(a.creep)})}}}}}};require("screeps-profiler").registerObject(Worker,"RoleWorker");module.exports=Worker;